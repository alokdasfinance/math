<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Math PDF Uploader</title>

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            padding: 30px;
            background: #fafafa;
        }

        h1 {
            margin-bottom: 10px;
        }

        button {
            padding: 8px 14px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 10px;
        }

        .top-actions {
            margin-bottom: 20px;
        }

        #progress-container {
            display: none;
            margin-top: 25px;
            max-width: 600px;
        }

        #progress-outer {
            width: 100%;
            background: #e0e0e0;
            height: 26px;
            border-radius: 6px;
            overflow: hidden;
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background: #4caf50;
            text-align: center;
            color: white;
            line-height: 26px;
            font-size: 14px;
            transition: width 0.2s ease;
        }

        #progress-text {
            margin-top: 8px;
            font-size: 14px;
        }

        .hint {
            margin-top: 10px;
            font-size: 13px;
            color: #555;
        }
    </style>
</head>
<body>

<h1>Upload Mathematics PDFs</h1>

<div class="top-actions">
    <a href="{{ saved_url }}">
        <button>View All Saved</button>
    </a>
</div>

<p>
    Select one or more PDF files. Large selections will be processed in batches.
</p>

<input type="file" id="fileInput" multiple accept=".pdf">
<br><br>

<button onclick="startUpload()">Upload & Process</button>

<div id="progress-container">
    <div id="progress-outer">
        <div id="progress-bar">0%</div>
    </div>
    <div id="progress-text"></div>
</div>

<p class="hint">
    Tip: You can upload thousands of PDFs â€” they will be processed safely in batches.
</p>

<script>
/*
  Smaller = safer but slower.
*/
const BATCH_SIZE = 20;

async function startUpload() {
    const input = document.getElementById("fileInput");
    const files = Array.from(input.files);

    if (files.length === 0) {
        alert("No files selected.");
        return;
    }

    const batchId = crypto.randomUUID();

    const progressContainer = document.getElementById("progress-container");
    const progressBar = document.getElementById("progress-bar");
    const progressText = document.getElementById("progress-text");

    progressContainer.style.display = "block";
    progressBar.style.width = "0%";
    progressBar.textContent = "0%";

    let processed = 0;

    for (let i = 0; i < files.length; i += BATCH_SIZE) {
        const batch = files.slice(i, i + BATCH_SIZE);
        const formData = new FormData();

        formData.append("batch_id", batchId);
        batch.forEach(f => formData.append("files", f));

        let response;
        try {
            response = await fetch("/upload", {
                method: "POST",
                body: formData
            });
        } catch (err) {
            alert("Network error during upload.");
            return;
        }

        if (!response.ok) {
            alert("Upload failed during batch processing.");
            return;
        }

        const data = await response.json();
        processed += data.processed || batch.length;

        const percent = Math.round((processed / files.length) * 100);
        progressBar.style.width = percent + "%";
        progressBar.textContent = percent + "%";
        progressText.textContent =
            `Processed ${processed} / ${files.length} PDFs`;
    }

    // Go to combined results page
    window.location.href = `/upload_complete/${batchId}`;
}
</script>

</body>
</html>
